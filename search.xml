<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[Dnsmasq-为小型网络环境提供DNS服务]]></title>
    <url>%2Fp%2F43d3dbac%2F</url>
    <content type="text"><![CDATA[Dnsmasq适用于小型网络架构，为其中的主机提供DNS、DHCP等服务。本文将介绍其DNS功能的简单使用，并在内网环境中搭建Dnsmasq服务器为两个节点提供DNS服务。 Dnsmasq 简介和适用平台 Dnsmasq provides network infrastructure for small networks: DNS, DHCP, router advertisement and network boot. It is designed to be lightweight and have a small footprint, suitable for resource constrained routers and firewalls. It has also been widely used for tethering on smartphones and portable hotspots, and to support virtual networking in virtualisation frameworks.Supported platforms include Linux (with glibc and uclibc), Android, *BSD, and Mac OS X. Dnsmasq is included in most Linux distributions and the ports systems of FreeBSD, OpenBSD and NetBSD. Dnsmasq provides full IPv6 support.摘自Dnsmasq官网 Dnsmasq 部署 主机名 IP地址 操作系统 dns-server 172.168.1.125 CentOS 7.2.1511 dns-client1 172.168.1.140 CentOS 6.8 dns-client2 172.168.1.141 CentOS 6.8 dns-server 安装 Dnsmasq通过yum安装使用网易开源镜像 CentOS7-Base-163.repo（CentOS6使用CentOS6-Base-163.repo文件）安装后的Dnsmasq版本为version 2.66，版本比较旧，如需安装新版本可以选择通过源码安装。12345678# 备份/etc/yum.repos.d/CentOS-Base.repomv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup# 下载对应操作系统版本repo文件，放入/etc/yum.repos.d/，此处直接wgetwget http://mirrors.163.com/.help/CentOS7-Base-163.repo -P /etc/yum.repos.d/# 清空yum缓存并安装Dnsmasqyum clean all &amp;&amp; yum install dnsmasq -y# 查看Dnsmasq版本dnsmasq -v 通过源码安装稳定版下载地址 http://www.thekelleys.org.uk/dnsmasq/，目前最新稳定版本为 2.76。测试版下载地址 http://www.thekelleys.org.uk/dnsmasq/test-releases/，目前最新测试版本为 2.77test3。123456# 此处直接clone最新版本git clone git://thekelleys.org.uk/dnsmasq.git# 进入目录开始编译，编译前确认安装了gcccd ./dnsmasq &amp;&amp; make &amp;&amp; make install# 查看Dnsmasq版本dnsmasq -v dns-server 启动 Dnsmasq 服务并设置开机启动1234567systemctl start dnsmasq.servicesystemctl enable dnsmasq.servicenetstat -tunlp | grep 53tcp 0 0 0.0.0.0:53 0.0.0.0:* LISTEN 1296/dnsmasq tcp6 0 0 :::53 :::* LISTEN 1296/dnsmasq udp 0 0 0.0.0.0:53 0.0.0.0:* 1296/dnsmasq udp6 0 0 :::53 :::* 1296/dnsmasq 所有节点关闭防火墙和SELINUX12systemctl stop firewalld.servicesed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config Dnsmasq 配置dns-server 配置dns-server 配置 /etc/dnsmasq.conf12345678910# 定义上游DNS服务器echo "resolv-file=/etc/resolv.dnsmasq.conf" &gt;&gt; /etc/dnsmasq.conf# 禁止读取本地hostsecho "no-hosts" &gt;&gt; /etc/dnsmasq.conf# 监听地址echo "listen-address=127.0.0.1,172.168.1.125" &gt;&gt; /etc/dnsmasq.conf# 指定使用本地DNS hosts文件echo "addn-hosts=/etc/dnsmasq.hosts" &gt;&gt; /etc/dnsmasq.conf# DNS缓存大小echo "cache-size=150" &gt;&gt; /etc/dnsmasq.conf dns-server 配置 /etc/resolv.conf12# 增加本地回环echo "nameserver 127.0.0.1" &gt;&gt; /etc/resolv.conf dns-server 配置 /etc/dnsmasq.hosts123# 增加需要解析的地址和域名echo "172.168.1.140 dns.test.com" &gt;&gt; /etc/dnsmasq.hostsecho "172.168.1.141 dns.test.com" &gt;&gt; /etc/dnsmasq.hosts dns-server 配置 /etc/resolv.dnsmasq.conf12# 增加上游DNS服务器，此处设置为本机echo "nameserver 172.168.1.125" &gt;&gt; /etc/resolv.dnsmasq.conf dns-server 重启 dnsmasq服务1systemctl restart dnsmasq.service dns-client 配置dns-client 配置 /etc/resolv.conf12# 配置DNS地址为dns-serverecho "nameserver 172.168.1.125" /etc/resolv.conf Dnsmasq 验证dns-server 端验证12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849[root@dns-server ~]# dig @172.168.1.125 dns.test.com; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-29.el7 &lt;&lt;&gt;&gt; @172.168.1.125 dns.test.com; (1 server found);; global options: +cmd;; Got answer:;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 33400;; flags: qr aa rd ra ad; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 0;; QUESTION SECTION:;dns.test.com. IN A;; ANSWER SECTION:dns.test.com. 0 IN A 172.168.1.141dns.test.com. 0 IN A 172.168.1.140;; Query time: 0 msec;; SERVER: 172.168.1.125#53(172.168.1.125);; WHEN: Mon Feb 13 19:28:42 CST 2017;; MSG SIZE rcvd: 62[root@dns-server ~]# nslookup dns.test.comServer: 172.168.1.125Address: 172.168.1.125#53Name: dns.test.comAddress: 172.168.1.140Name: dns.test.comAddress: 172.168.1.141[root@dns-server ~]# ping dns.test.com PING dns.test.com (172.168.1.141) 56(84) bytes of data.64 bytes from dns.test.com (172.168.1.141): icmp_seq=1 ttl=64 time=0.238 ms64 bytes from dns.test.com (172.168.1.141): icmp_seq=2 ttl=64 time=0.230 ms64 bytes from dns.test.com (172.168.1.141): icmp_seq=3 ttl=64 time=0.174 ms^C--- dns.test.com ping statistics ---3 packets transmitted, 3 received, 0% packet loss, time 1999msrtt min/avg/max/mdev = 0.174/0.214/0.238/0.028 ms[root@dns-server ~]# ping dns.test.comPING dns.test.com (172.168.1.140) 56(84) bytes of data.64 bytes from dns.test.com (172.168.1.140): icmp_seq=1 ttl=64 time=0.229 ms64 bytes from dns.test.com (172.168.1.140): icmp_seq=2 ttl=64 time=0.210 ms64 bytes from dns.test.com (172.168.1.140): icmp_seq=3 ttl=64 time=0.218 ms^C--- dns.test.com ping statistics ---3 packets transmitted, 3 received, 0% packet loss, time 2000msrtt min/avg/max/mdev = 0.210/0.219/0.229/0.007 ms dns-client 端验证12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849[root@dns-client1 ~]# dig @172.168.1.125 dns.test.com; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.47.rc1.el6 &lt;&lt;&gt;&gt; @172.168.1.125 dns.test.com; (1 server found);; global options: +cmd;; Got answer:;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 60940;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 0;; QUESTION SECTION:;dns.test.com. IN A;; ANSWER SECTION:dns.test.com. 0 IN A 172.168.1.140dns.test.com. 0 IN A 172.168.1.141;; Query time: 0 msec;; SERVER: 172.168.1.125#53(172.168.1.125);; WHEN: Mon Feb 13 19:33:17 2017;; MSG SIZE rcvd: 62[root@dns-client1 ~]# nslookup dns.test.comServer: 172.168.1.125Address: 172.168.1.125#53Name: dns.test.comAddress: 172.168.1.141Name: dns.test.comAddress: 172.168.1.140[root@dns-client1 ~]# ping dns.test.comPING dns.test.com (172.168.1.141) 56(84) bytes of data.64 bytes from dns.test.com (172.168.1.141): icmp_seq=1 ttl=64 time=0.248 ms64 bytes from dns.test.com (172.168.1.141): icmp_seq=2 ttl=64 time=0.360 ms64 bytes from dns.test.com (172.168.1.141): icmp_seq=3 ttl=64 time=0.274 ms^C--- dns.test.com ping statistics ---3 packets transmitted, 3 received, 0% packet loss, time 2312msrtt min/avg/max/mdev = 0.248/0.294/0.360/0.047 ms[root@dns-client1 ~]# ping dns.test.comPING dns.test.com (172.168.1.140) 56(84) bytes of data.64 bytes from dns.test.com (172.168.1.140): icmp_seq=1 ttl=64 time=0.037 ms64 bytes from dns.test.com (172.168.1.140): icmp_seq=2 ttl=64 time=0.017 ms64 bytes from dns.test.com (172.168.1.140): icmp_seq=3 ttl=64 time=0.017 ms^C--- dns.test.com ping statistics ---3 packets transmitted, 3 received, 0% packet loss, time 2405msrtt min/avg/max/mdev = 0.017/0.023/0.037/0.011 ms]]></content>
      <categories>
        <category>Linux服务配置</category>
      </categories>
      <tags>
        <tag>Dnsmasq</tag>
      </tags>
  </entry>
</search>